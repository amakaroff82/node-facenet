
<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>WebcamJS Test Page</title>
  <style type="text/css">
    body { font-family: Helvetica, sans-serif; }
    h2, h3 { margin-top:0; }
    form { margin-top: 15px; }
    form > input { margin-right: 15px; }
    #results { float:right; margin:20px; padding:20px; border:1px solid; background:#ccc; }
    #layer { position: absolute; height: 480px; width: 640px; top: 0px }
    #preview { position: relative }
  </style>
</head>
<body>


<h1>CoreVision</h1>
<h3>Face Recognition Tool</h3>

<div id="preview">
  <div id="my_camera"></div>
  <canvas id="layer" height="480" width="640"></canvas>
</div>

<!-- First, include the Webcam.js JavaScript Library -->
<script type="text/javascript" src="./lib/webcam.min.js"></script>

<!-- Configure a few settings and attach camera -->
<script language="JavaScript">
  Webcam.set({
    width: 640,
    height: 480,
    image_format: 'jpeg',
    jpeg_quality: 70
  });
  Webcam.attach( '#my_camera' );
</script>

<form>
  <input type=button value="Start" onClick="startStream()">
  <input type=button value="Save User" onClick="saveUser(this)">
</form>

<script language="JavaScript">
  var users = [];
  var lastFaces = [];
  var color = ["red", "blue", "green", "pink", "cian", "orange"]

  var canvas = document.getElementById('layer');
  canvas.addEventListener("click", saveUser);
  var ctx = canvas.getContext('2d');

  function updateTracking(items) {
    lastFaces = items;

    checkFaces(items);

    ctx.fillStyle = 'rgba(225,225,225,1.0)';
    ctx.clearRect(0, 0, 640, 480);

    for(var i = 0; i < items.length; i++){
      var item = items[i];
      var pos = item.location;

      ctx.beginPath();

      ctx.font = "12px Arial";
      ctx.fillText(item.name ,pos.x, pos.y - 6);

      if(item.landmark && item.landmark.leftEye && item.landmark.rightEye) {
        ctx.arc(item.landmark.leftEye.x, item.landmark.leftEye.y, 3, 0, 2 * Math.PI, false);
        ctx.arc(item.landmark.rightEye.x, item.landmark.rightEye.y, 3, 0, 2 * Math.PI, false);
      }

      ctx.strokeSize="1";
      ctx.strokeStyle=color[i];
      ctx.rect(pos.x, pos.y, pos.w, pos.h);
      ctx.stroke();
      ctx.closePath();
    }
  }

  function FromBase64(str) {
    return atob(str).split('').map(function (c) { return c.charCodeAt(0); });
  }


  function checkFaces(faces) {
    for(var i = 0; i < faces.length; i++){
      var face = faces[i]
      for(var j = 0; j < users.length; j++){
        var user = users[j];
        var res = match(face.embedding, user.embedding);
        console.log(res)
        if(res < 1.0){
          face.name = user.name;
          break;
        } else {
          face.name = "Unknown user";
        }
      }
    }
  }

  function match(e1, e2){
    var res = 0.0;
    for(var i = 0; i < 128; i++){
      res += ((e1[i] - e2[i]) ** 2);
    }
    return Math.sqrt(res);
  }

  function saveUser(src, evt) {
    var rect = src.target.getBoundingClientRect();
    var pos = {
      x: src.clientX - rect.left,
      y: src.clientY - rect.top
    };

    var newUser = null;

    for(var i = 0; i < lastFaces.length; i++){
      var l = lastFaces[i].location;
      if(l.x < pos.x && pos.x < (l.x + l.w) &&
         l.y < pos.y && pos.y < (l.y + l.h) )
      {
        var name = prompt('Enter Name for a new user');
        if(name) {
          var user = {
            name: name,
            embedding: lastFaces[i].embedding
          };

          users.push(user);
          localStorage.users = JSON.stringify(users);
        }
      }
    }
  }

  //function newUser()

  function startStream() {
    Webcam.snap( function(data_uri) {
      const payload = {
        command: 1,
        image: data_uri
      }
      const myRequest = new Request('/api', {method: 'POST', body: JSON.stringify(payload)});
      fetch(myRequest).then(response => {
          if (response.status === 200) {
            response.json().then((res)=>{
              if(res && res.length){
                updateTracking(res);
              }

              startStream();
            });

          } else {
            throw new Error('Something went wrong on api server!');
          }
        }).catch(error => {
            console.error(error);
        });
    } );
  }

  setTimeout(()=>{
    startStream();
  },1000)


  if(localStorage.users){
    users = JSON.parse(localStorage.users);
  }

</script>

</body>
</html>
